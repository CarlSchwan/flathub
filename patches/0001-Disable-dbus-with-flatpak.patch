From c48b87021f2e8c2071439210fbfb0a179e4c8693 Mon Sep 17 00:00:00 2001
From: Carl Schwan <carl@carlschwan.eu>
Date: Thu, 29 Aug 2024 00:05:05 +0200
Subject: [PATCH] Disable dbus with flatpak

---
 CMakeLists.txt             | 2 +-
 libs/main/CMakeLists.txt   | 4 ++--
 sheets/part/CMakeLists.txt | 4 ++--
 stage/part/CMakeLists.txt  | 2 +-
 4 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index af970132fc5..fefcf3cbb76 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -211,7 +211,7 @@ add_definitions(
     -DQT_DISABLE_DEPRECATED_BEFORE=0x050600
     )
 
-if(UNIX AND NOT APPLE AND NOT ANDROID)
+if(UNIX AND NOT APPLE AND NOT ANDROID AND NOT CALLIGRA_FLATPAK)
     add_definitions(-DWITH_QTDBUS)
     find_package(Qt6 ${REQUIRED_KF6_VERSION} REQUIRED
         COMPONENTS
diff --git a/libs/main/CMakeLists.txt b/libs/main/CMakeLists.txt
index d0989b7c89f..b206bf98704 100644
--- a/libs/main/CMakeLists.txt
+++ b/libs/main/CMakeLists.txt
@@ -67,7 +67,7 @@ set(komain_LIB_SRCS
     MainDebug.cpp
 )
 
-if(TARGET Qt6::DBus)
+if(UNIX AND NOT APPLE AND NOT ANDROID AND NOT CALLIGRA_FLATPAK)
     set(komain_LIB_SRCS ${komain_LIB_SRCS}
         KoApplicationAdaptor.cpp
         KoViewAdaptor.cpp
@@ -163,7 +163,7 @@ install( FILES
     komain_export.h
 DESTINATION ${KDE_INSTALL_INCLUDEDIR}/calligra COMPONENT Devel)
 
-if(TARGET Qt6::DBus)
+if(UNIX AND NOT APPLE AND NOT ANDROID AND NOT CALLIGRA_FLATPAK)
     install( FILES
         KoApplicationAdaptor.h
         KoViewAdaptor.h
diff --git a/sheets/part/CMakeLists.txt b/sheets/part/CMakeLists.txt
index 23aa0d81182..d24689097ec 100644
--- a/sheets/part/CMakeLists.txt
+++ b/sheets/part/CMakeLists.txt
@@ -27,7 +27,7 @@ ki18n_wrap_ui(dialogs_DIR_SRCS
     dialogs/SheetSelectWidget.ui
 )
 
-if(TARGET Qt6::DBus)
+if(UNIX AND NOT APPLE AND NOT ANDROID AND NOT CALLIGRA_FLATPAK)
 set (interfaces_DIR_SRCS
     MapAdaptor.cpp
     SheetAdaptor.cpp
@@ -61,7 +61,7 @@ set (calligrasheetspartlib_LIB_SRCS
     ${dialogs_DIR_SRCS}
 )
 
-if(TARGET Qt6::DBus)
+if(UNIX AND NOT APPLE AND NOT ANDROID AND NOT CALLIGRA_FLATPAK)
 set (calligrasheetspartlib_LIB_SRCS
     ${calligrasheetspartlib_LIB_SRCS}
     ${interfaces_DIR_SRCS}
diff --git a/stage/part/CMakeLists.txt b/stage/part/CMakeLists.txt
index a84648207ae..047a42b2daa 100644
--- a/stage/part/CMakeLists.txt
+++ b/stage/part/CMakeLists.txt
@@ -134,7 +134,7 @@ set( calligrastageprivate_LIB_SRCS
      tools/KPrPlaceholderToolFactory.cpp
    )
 
-if(TARGET Qt6::DBus)
+if(UNIX AND NOT APPLE AND NOT ANDROID AND NOT CALLIGRA_FLATPAK)
     set(calligrastageprivate_LIB_SRCS
         ${calligrastageprivate_LIB_SRCS}
         KPrViewAdaptor.cpp
-- 
2.45.2

