From d77bc5800aa0594168dc62352d5d43a37822092c Mon Sep 17 00:00:00 2001
From: Carl Schwan <carl@carlschwan.eu>
Date: Tue, 27 Aug 2024 22:22:21 +0200
Subject: [PATCH 01/13] Fix icons loading on wayland

---
 braindump/data/CMakeLists.txt                 |  1 +
 .../data/org.kde.calligra.braindump.desktop   |  2 +-
 braindump/data/org.kde.calligra.braindump.svg | 73 +++++++++++++++++++
 gemini/main.cpp                               |  2 +
 karbon/data/CMakeLists.txt                    |  1 +
 karbon/data/org.kde.calligra.karbon.desktop   |  2 +-
 karbon/data/org.kde.calligra.karbon.svg       |  1 +
 karbon/main.cpp                               |  2 +-
 sheets/app/CMakeLists.txt                     |  5 +-
 sheets/app/Main.cpp                           |  2 +-
 sheets/app/org.kde.calligra.sheets.desktop    |  2 +-
 sheets/app/org.kde.calligra.sheets.svg        |  1 +
 stage/app/CMakeLists.txt                      |  5 +-
 stage/app/main.cpp                            |  2 +-
 stage/app/org.kde.calligra.stage.desktop      |  2 +-
 stage/app/org.kde.calligra.stage.svg          |  1 +
 words/app/CMakeLists.txt                      |  5 +-
 words/app/main.cpp                            |  4 +-
 words/app/org.kde.calligra.words.desktop      |  2 +-
 words/app/org.kde.calligra.words.svg          |  1 +
 20 files changed, 100 insertions(+), 16 deletions(-)
 create mode 100644 braindump/data/org.kde.calligra.braindump.svg
 create mode 120000 karbon/data/org.kde.calligra.karbon.svg
 create mode 120000 sheets/app/org.kde.calligra.sheets.svg
 create mode 120000 stage/app/org.kde.calligra.stage.svg
 create mode 120000 words/app/org.kde.calligra.words.svg

diff --git a/braindump/data/CMakeLists.txt b/braindump/data/CMakeLists.txt
index f0f3f662c1f..e751f33c9f5 100644
--- a/braindump/data/CMakeLists.txt
+++ b/braindump/data/CMakeLists.txt
@@ -11,3 +11,4 @@ install( FILES braindumpui.rc braindumpview.rc DESTINATION ${KDE_INSTALL_KXMLGUI
 ### desktop files ###
 install( PROGRAMS org.kde.calligra.braindump.desktop DESTINATION ${KDE_INSTALL_APPDIR})
 install( FILES org.kde.calligra.braindump.metainfo.xml DESTINATION ${KDE_INSTALL_METAINFODIR})
+install(FILES org.kde.calligra.braindump.svg DESTINATION ${KDE_INSTALL_FULL_ICONDIR}/hicolor/scalable/apps)
diff --git a/braindump/data/org.kde.calligra.braindump.desktop b/braindump/data/org.kde.calligra.braindump.desktop
index 198c46b1497..64ca31674fa 100755
--- a/braindump/data/org.kde.calligra.braindump.desktop
+++ b/braindump/data/org.kde.calligra.braindump.desktop
@@ -41,7 +41,7 @@ GenericName[tr]=Notlar ve fikir toplama
 GenericName[uk]=Програма для впорядковування нотаток та ідей
 GenericName[x-test]=xxNotes and idea gatheringxx
 GenericName[zh_CN]=笔记和想法收集
-Icon=braindump
+Icon=org.kde.calligra.braindump
 Name=Braindump
 Name[bs]=Braindump
 Name[ca]=Braindump
diff --git a/braindump/data/org.kde.calligra.braindump.svg b/braindump/data/org.kde.calligra.braindump.svg
new file mode 100644
index 00000000000..766f353e917
--- /dev/null
+++ b/braindump/data/org.kde.calligra.braindump.svg
@@ -0,0 +1,73 @@
+<svg width="48" xmlns="http://www.w3.org/2000/svg" height="48" xmlns:xlink="http://www.w3.org/1999/xlink">
+ <defs>
+  <linearGradient id="a" y1="42" x1="27" y2="38" x2="21" gradientUnits="userSpaceOnUse">
+   <stop stop-color="#95a5a6"/>
+   <stop offset="1" stop-color="#eff0f1"/>
+  </linearGradient>
+  <linearGradient id="b" y1="38" y2="13" x2="0" gradientUnits="userSpaceOnUse">
+   <stop stop-color="#f39c12"/>
+   <stop offset="1" stop-color="#f5ab35"/>
+  </linearGradient>
+  <linearGradient xlink:href="#a" id="c" y1="47.746" x1="12.05" y2="42.4" x2="11.415" gradientUnits="userSpaceOnUse"/>
+  <linearGradient id="d" y1="37" y2="17" x1="28" gradientUnits="userSpaceOnUse" x2="24" gradientTransform="translate(0 1)">
+   <stop stop-color="#f7bb5d"/>
+   <stop offset="1" stop-color="#fce3bc"/>
+  </linearGradient>
+  <linearGradient id="e" y1="17.998" y2="32.998" x1="23" gradientUnits="userSpaceOnUse" x2="38">
+   <stop stop-color="#292c2f"/>
+   <stop offset="1" stop-opacity="0"/>
+  </linearGradient>
+  <linearGradient xlink:href="#e" id="f" y1="40" x1="21" y2="42" x2="23" gradientUnits="userSpaceOnUse"/>
+  <linearGradient xlink:href="#e" id="g" y1="40" x1="20" y2="44" x2="24" gradientUnits="userSpaceOnUse" gradientTransform="translate(0-2)"/>
+  <linearGradient xlink:href="#e" id="h" y1="40" x1="21" y2="42" x2="23" gradientUnits="userSpaceOnUse" gradientTransform="translate(1 2)"/>
+ </defs>
+ <g stroke-linejoin="bevel" stroke-width="6.2">
+  <g stroke-linecap="round">
+   <rect width="4" x="22" y="41" fill="#4d4d4d" height="3"/>
+   <g transform="rotate(-30)">
+    <circle fill="#258e52" cx="8.584" cy="15.644" r="5.256"/>
+    <circle fill="#2980b9" cx="9.245" cy="50.963" r="3.488"/>
+   </g>
+   <g transform="rotate(30)">
+    <circle fill="#1c7865" cx="33.429" cy="-8.612" r="4.256"/>
+    <circle fill="#c0392b" cx="31.629" cy="26.758" r="4.01"/>
+   </g>
+   <g transform="rotate(90)">
+    <circle fill="#663579" cx="24" cy="-41.02" r="4.975"/>
+    <circle fill="#f67400" cx="24" cy="-7" r="5"/>
+   </g>
+  </g>
+  <path fill="url(#b)" d="m24 14c-5.523 0-10 4.477-10 10 .002 3.974 2 6.32 4 8.16 2 1.84 1 4.84 2 5.84h8c1-1 0-4 2-5.848 2-1.848 3.995-4.181 4-8.152 0-5.523-4.477-10-10-10"/>
+  <path fill="url(#a)" d="m20 38h8l-1 1v3l-1 1h-4l-1-1v-3z"/>
+ </g>
+ <g fill-rule="evenodd">
+  <path opacity=".2" fill="url(#h)" d="m22 42l1 1h3v-2z"/>
+  <path opacity=".2" fill="url(#g)" d="m25 43l2-1v-3l1-1h-8z"/>
+  <path opacity=".2" fill="url(#f)" d="m21 41l1 1 5-1v-2l-6 1z"/>
+ </g>
+ <g fill="url(#c)" stroke-linejoin="bevel" stroke-linecap="round" stroke-width="6.2">
+  <rect width="8" x="8.44" y="45.8" rx=".5" height="1" transform="rotate(-15)"/>
+  <rect width="8" x="8.96" y="43.87" rx=".5" height="1" transform="rotate(-15)"/>
+ </g>
+ <g fill-rule="evenodd">
+  <path opacity=".2" fill="url(#e)" d="m25 18l-2 14 5.342 5.342c.398-1.314-.012-3.646 1.658-5.189 1.506-1.391 3.01-3.059 3.66-5.492z"/>
+  <path fill="url(#d)" d="m25 18l-5 8h3v6l5-8h-3z"/>
+ </g>
+ <g stroke-linejoin="bevel" stroke-width="6.2">
+  <path fill="#b97c1b" d="m33.973 23.434c-.149 3.7-2.049 5.942-3.973 7.719-2 1.848-1 4.848-2 5.848h-8c-1-1 0-4-2-5.84-1.922-1.768-3.825-4.02-3.973-7.721-.01.187-.027.371-.027.561.002 3.974 2 6.32 4 8.16 2 1.84 1 4.84 2 5.84h8c1-1 0-4 2-5.848 2-1.848 3.995-4.181 4-8.152 0-.191-.017-.378-.027-.566"/>
+  <g fill="#fcfcfc" stroke-linecap="round">
+   <g transform="rotate(-30)">
+    <circle cx="8.584" cy="15.644" r="3.256"/>
+    <circle cx="9.245" cy="50.963" r="1.512"/>
+   </g>
+   <g transform="rotate(30)">
+    <circle cx="33.429" cy="-8.612" r="1.744"/>
+    <circle cx="31.629" cy="26.758" r="1.988"/>
+   </g>
+   <g transform="rotate(90)">
+    <circle cx="24" cy="-41.02" r="3"/>
+    <circle cx="24" cy="-7" r="1"/>
+   </g>
+  </g>
+ </g>
+</svg>
diff --git a/gemini/main.cpp b/gemini/main.cpp
index 8920b14ef94..bda306da0df 100644
--- a/gemini/main.cpp
+++ b/gemini/main.cpp
@@ -47,6 +47,8 @@ int main(int argc, char **argv)
     app.setAttribute(Qt::AA_DontCreateNativeWidgetSiblings, true);
     KAboutData::setApplicationData(aboutData);
 
+    QGuiApplication::setWindowIcon(QIcon::fromTheme(QStringLiteral("calligragemini")));
+
     QCommandLineParser parser;
     aboutData.setupCommandLine(&parser);
 
diff --git a/karbon/data/CMakeLists.txt b/karbon/data/CMakeLists.txt
index 4c11b7807c2..42006ce09bc 100644
--- a/karbon/data/CMakeLists.txt
+++ b/karbon/data/CMakeLists.txt
@@ -3,6 +3,7 @@ install( FILES  palettes/svg-colors.gpl DESTINATION ${KDE_INSTALL_DATADIR}/karbo
 install( FILES  karbon.rc karbon_readonly.rc  DESTINATION ${KDE_INSTALL_KXMLGUIDIR}/karbon)
 install( PROGRAMS  org.kde.calligra.karbon.desktop  DESTINATION ${KDE_INSTALL_APPDIR})
 install( FILES org.kde.calligra.karbon.metainfo.xml DESTINATION ${KDE_INSTALL_METAINFODIR})
+install(FILES org.kde.calligra.karbon.svg DESTINATION ${KDE_INSTALL_FULL_ICONDIR}/hicolor/scalable/apps)
 install( FILES  karbonrc DESTINATION ${KDE_INSTALL_CONFDIR} )
 
 # TODO: with the new embedded JSON data for plugins there is no schema ATM to define extended properties
diff --git a/karbon/data/org.kde.calligra.karbon.desktop b/karbon/data/org.kde.calligra.karbon.desktop
index a56ec8294f2..92d022e5769 100644
--- a/karbon/data/org.kde.calligra.karbon.desktop
+++ b/karbon/data/org.kde.calligra.karbon.desktop
@@ -108,7 +108,7 @@ MimeType=application/vnd.oasis.opendocument.graphics;application/x-karbon;image/
 # kghostview has 6 for application/postscript, we need to be under that...
 InitialPreference=5
 X-KDE-ServiceTypes=Calligra/Application
-Icon=calligrakarbon
+Icon=org.kde.calligra.karbon
 X-KDE-NativeMimeType=application/vnd.oasis.opendocument.graphics
 X-Calligra-DefaultMimeTypes=application/vnd.oasis.opendocument.graphics,application/x-karbon,image/x-eps,application/postscript,image/svg+xml,image/svg+xml-compressed,image/x-wmf,application/pdf,
 Categories=Qt;KDE;Graphics;Office;VectorGraphics;
diff --git a/karbon/data/org.kde.calligra.karbon.svg b/karbon/data/org.kde.calligra.karbon.svg
new file mode 120000
index 00000000000..df8a6d2e7a2
--- /dev/null
+++ b/karbon/data/org.kde.calligra.karbon.svg
@@ -0,0 +1 @@
+karbon.svg
\ No newline at end of file
diff --git a/karbon/main.cpp b/karbon/main.cpp
index 8d85415be84..d1cf5265b48 100644
--- a/karbon/main.cpp
+++ b/karbon/main.cpp
@@ -56,7 +56,7 @@ int main(int argc, char *argv[])
         "calligra.*.debug=false\n"
         "calligra.*.warning=true");
 
-    KoApplication app(KARBON_MIME_TYPE, QStringLiteral("calligrakarbon"), newKarbonAboutData, argc, argv);
+    KoApplication app(KARBON_MIME_TYPE, QStringLiteral("org.kde.calligra.karbon"), newKarbonAboutData, argc, argv);
     KLocalizedString::setApplicationDomain("karbon");
 
     if (!app.start()) { // parses command line args, create initial docs and mainwindows
diff --git a/sheets/app/CMakeLists.txt b/sheets/app/CMakeLists.txt
index 346c4d2be31..ee5efc5cad1 100644
--- a/sheets/app/CMakeLists.txt
+++ b/sheets/app/CMakeLists.txt
@@ -26,7 +26,8 @@ target_include_directories(calligrasheets
 
 install(TARGETS calligrasheets  ${KDE_INSTALL_TARGETS_DEFAULT_ARGS})
 
-install( PROGRAMS  org.kde.calligra.sheets.desktop DESTINATION ${KDE_INSTALL_APPDIR})
-install( FILES org.kde.calligra.sheets.metainfo.xml DESTINATION ${KDE_INSTALL_METAINFODIR})
+install(PROGRAMS org.kde.calligra.sheets.desktop DESTINATION ${KDE_INSTALL_APPDIR})
+install(FILES org.kde.calligra.sheets.metainfo.xml DESTINATION ${KDE_INSTALL_METAINFODIR})
+install(FILES org.kde.calligra.sheets.svg DESTINATION ${KDE_INSTALL_FULL_ICONDIR}/hicolor/scalable/apps)
 
 
diff --git a/sheets/app/Main.cpp b/sheets/app/Main.cpp
index 8b0e2dfe4ff..96a507f9aaf 100644
--- a/sheets/app/Main.cpp
+++ b/sheets/app/Main.cpp
@@ -31,7 +31,7 @@ int main(int argc, char **argv)
     // QT5TODO: support custom options
     //     options.add("scriptfile <scriptfile>", ki18n("Execute the scriptfile after startup."));
 
-    KoApplication app(SHEETS_MIME_TYPE, QStringLiteral("calligrasheets"), newAboutData, argc, argv);
+    KoApplication app(SHEETS_MIME_TYPE, QStringLiteral("org.kde.calligra.sheets"), newAboutData, argc, argv);
     KLocalizedString::setApplicationDomain("calligrasheets");
 
     if (!app.start()) {
diff --git a/sheets/app/org.kde.calligra.sheets.desktop b/sheets/app/org.kde.calligra.sheets.desktop
index a50aecbefee..f8cc7aaa30d 100644
--- a/sheets/app/org.kde.calligra.sheets.desktop
+++ b/sheets/app/org.kde.calligra.sheets.desktop
@@ -136,7 +136,7 @@ Comment[zh_CN]=编写电子表格文档
 Comment[zh_TW]=撰寫工作表文件
 MimeType=application/vnd.oasis.opendocument.spreadsheet;application/x-kspread;application/vnd.ms-excel;text/csv;application/x-quattropro;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;application/vnd.openxmlformats-officedocument.spreadsheetml.template;
 Type=Application
-Icon=calligrasheets
+Icon=org.kde.calligra.sheets
 X-KDE-ServiceTypes=Calligra/Application
 X-Calligra-DefaultMimeTypes=application/vnd.oasis.opendocument.spreadsheet,application/x-kspread,application/vnd.ms-excel,text/csv,application/x-quattropro,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.openxmlformats-officedocument.spreadsheetml.template
 X-KDE-NativeMimeType=application/vnd.oasis.opendocument.spreadsheet
diff --git a/sheets/app/org.kde.calligra.sheets.svg b/sheets/app/org.kde.calligra.sheets.svg
new file mode 120000
index 00000000000..3a386bb7a59
--- /dev/null
+++ b/sheets/app/org.kde.calligra.sheets.svg
@@ -0,0 +1 @@
+sheets.svg
\ No newline at end of file
diff --git a/stage/app/CMakeLists.txt b/stage/app/CMakeLists.txt
index 8a521f98755..aaa04043694 100644
--- a/stage/app/CMakeLists.txt
+++ b/stage/app/CMakeLists.txt
@@ -25,5 +25,6 @@ target_link_libraries(calligrastage komain)
 
 install(TARGETS calligrastage ${KDE_INSTALL_TARGETS_DEFAULT_ARGS})
 
-install( PROGRAMS org.kde.calligra.stage.desktop DESTINATION ${KDE_INSTALL_APPDIR})
-install( FILES org.kde.calligra.stage.metainfo.xml DESTINATION ${KDE_INSTALL_METAINFODIR})
+install(PROGRAMS org.kde.calligra.stage.desktop DESTINATION ${KDE_INSTALL_APPDIR})
+install(FILES org.kde.calligra.stage.metainfo.xml DESTINATION ${KDE_INSTALL_METAINFODIR})
+install(FILES org.kde.calligra.stage.svg DESTINATION ${KDE_INSTALL_FULL_ICONDIR}/hicolor/scalable/apps)
diff --git a/stage/app/main.cpp b/stage/app/main.cpp
index 547be05ec08..6d3003e6201 100644
--- a/stage/app/main.cpp
+++ b/stage/app/main.cpp
@@ -26,7 +26,7 @@ int main(int argc, char **argv)
         "calligra.*.debug=false\n"
         "calligra.*.warning=true");
 
-    KoApplication app(STAGE_MIME_TYPE, QStringLiteral("calligrastage"), newKPresenterAboutData, argc, argv);
+    KoApplication app(STAGE_MIME_TYPE, QStringLiteral("org.kde.calligra.stage"), newKPresenterAboutData, argc, argv);
     KLocalizedString::setApplicationDomain("calligrastage");
 
     if (!app.start()) {
diff --git a/stage/app/org.kde.calligra.stage.desktop b/stage/app/org.kde.calligra.stage.desktop
index 67fe0a0b5f9..92d11015bee 100644
--- a/stage/app/org.kde.calligra.stage.desktop
+++ b/stage/app/org.kde.calligra.stage.desktop
@@ -141,7 +141,7 @@ Comment[zh_CN]=编写演示文稿
 Comment[zh_TW]=撰寫簡報文件
 MimeType=application/vnd.oasis.opendocument.presentation;application/vnd.oasis.opendocument.presentation-template;application/x-kpresenter;application/vnd.ms-powerpoint;application/vnd.openxmlformats-officedocument.presentationml.presentation;application/vnd.openxmlformats-officedocument.presentationml.template;
 X-KDE-ServiceTypes=Calligra/Application
-Icon=calligrastage
+Icon=org.kde.calligra.stage
 X-KDE-NativeMimeType=application/vnd.oasis.opendocument.presentation
 X-Calligra-DefaultMimeTypes=application/vnd.oasis.opendocument.presentation,application/vnd.oasis.opendocument.presentation-template,application/x-kpresenter,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,application/vnd.openxmlformats-officedocument.presentationml.template
 X-DBUS-StartupType=multi
diff --git a/stage/app/org.kde.calligra.stage.svg b/stage/app/org.kde.calligra.stage.svg
new file mode 120000
index 00000000000..1151ae96d71
--- /dev/null
+++ b/stage/app/org.kde.calligra.stage.svg
@@ -0,0 +1 @@
+stage.svg
\ No newline at end of file
diff --git a/words/app/CMakeLists.txt b/words/app/CMakeLists.txt
index 66c740dea0a..e8274daa7a9 100644
--- a/words/app/CMakeLists.txt
+++ b/words/app/CMakeLists.txt
@@ -28,5 +28,6 @@ install(TARGETS calligrawords  ${KDE_INSTALL_TARGETS_DEFAULT_ARGS})
 
 install(TARGETS calligrawords  ${KDE_INSTALL_TARGETS_DEFAULT_ARGS})
 
-install( PROGRAMS org.kde.calligra.words.desktop  DESTINATION ${KDE_INSTALL_APPDIR})
-install( FILES org.kde.calligra.words.metainfo.xml DESTINATION ${KDE_INSTALL_METAINFODIR})
+install(PROGRAMS org.kde.calligra.words.desktop  DESTINATION ${KDE_INSTALL_APPDIR})
+install(FILES org.kde.calligra.words.metainfo.xml DESTINATION ${KDE_INSTALL_METAINFODIR})
+install(FILES org.kde.calligra.words.svg DESTINATION ${KDE_INSTALL_FULL_ICONDIR}/hicolor/scalable/apps)
diff --git a/words/app/main.cpp b/words/app/main.cpp
index 425c508bdb1..9143b0ac650 100644
--- a/words/app/main.cpp
+++ b/words/app/main.cpp
@@ -26,12 +26,12 @@ int main(int argc, char **argv)
         "calligra.*.debug=false\n"
         "calligra.*.warning=true");
 
-    KoApplication app(WORDS_MIME_TYPE, QStringLiteral("calligrawords"), newWordsAboutData, argc, argv);
+    KoApplication app(WORDS_MIME_TYPE, QStringLiteral("org.kde.calligra.words"), newWordsAboutData, argc, argv);
     KLocalizedString::setApplicationDomain("calligrawords");
 
     if (!app.start()) {
         return 1;
     }
 
-    return app.exec();
+    return KoApplication::exec();
 }
diff --git a/words/app/org.kde.calligra.words.desktop b/words/app/org.kde.calligra.words.desktop
index e6e7d006c5e..c5a9eb60558 100644
--- a/words/app/org.kde.calligra.words.desktop
+++ b/words/app/org.kde.calligra.words.desktop
@@ -142,7 +142,7 @@ Comment[zh_CN]=编写文档
 Comment[zh_TW]=寫文件
 MimeType=application/vnd.oasis.opendocument.text;application/vnd.oasis.opendocument.text-template;application/msword;application/rtf;application/x-mswrite;application/vnd.openxmlformats-officedocument.wordprocessingml.document;application/vnd.openxmlformats-officedocument.wordprocessingml.template;application/vnd.ms-works;application/vnd.wordperfect;
 X-KDE-ServiceTypes=Calligra/Application
-Icon=calligrawords
+Icon=org.kde.calligra.words
 X-KDE-NativeMimeType=application/vnd.oasis.opendocument.text
 X-Calligra-DefaultMimeTypes=application/vnd.oasis.opendocument.text,application/vnd.oasis.opendocument.text-template,application/msword,application/rtf,application/x-mswrite,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.wordprocessingml.template,application/vnd.ms-works,application/vnd.wordperfect
 X-DocPath=http://userbase.kde.org/Special:MyLanguage/Words
diff --git a/words/app/org.kde.calligra.words.svg b/words/app/org.kde.calligra.words.svg
new file mode 120000
index 00000000000..e30a949f8d7
--- /dev/null
+++ b/words/app/org.kde.calligra.words.svg
@@ -0,0 +1 @@
+words.svg
\ No newline at end of file
-- 
2.45.2

